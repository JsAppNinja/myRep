//= require ./frontend/index

window.addEventListener('message', function(event) {
  var publicFunctions = ["createPopupActivation()", "listenPopupSubmit()"],
      session_token   = "",
      EMAIL_REGEXP    = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;

  var index = publicFunctions.indexOf(event.data.method);

  if (index >= 0) {
    eval(publicFunctions[index]);
  }
  else {
    return "Don't know that function :("
  }

  function createPopupActivation() {
    var token = window.token;

    var params = {
      popup_activation: {
        token:     token,
        url:       event.data.params.url,
        shop_name: event.data.params.shop_name
      }
    };

    sendRequest("POST", "/api/v1/popup_activation", params,
      function(){
        window.session_token = JSON.parse(response.responseText).session_token;
      });
  }

  function listenPopupSubmit() {
    document.getElementById('submit-email').onclick = function () {
      var email  = document.getElementById('email-field').value;

      if (EMAIL_REGEXP.test(email)) {

        if (window.session_token.length == 0) return;

        var params = {
          popup_submit: {
            email:         email,
            token:         window.token,
            session_token: window.session_token
          }
        };

        params.popup_submit = Object.assign(params.popup_submit, event.data.params);
        sendRequest("POST", "/api/v1/popup_submits", params, function() {
            console.log(response);
          })
      }
      else console.log("Invalid email!!!")
    }
  }

  function sendRequest (type, url, params, block) {
    var xmlhttp  = new XMLHttpRequest();

    xmlhttp.open(type, "<%= ENV["SCRIPTS_HOST"] %>" + url, true);
    xmlhttp.setRequestHeader("Content-Type", "application/json");
    xmlhttp.send(JSON.stringify(params));

    xmlhttp.onreadystatechange = function () {
      if (xmlhttp.readyState != 4) return;

      if (xmlhttp.status == 200) {
        response = xmlhttp;
        block();
      }
    }

  }
});
