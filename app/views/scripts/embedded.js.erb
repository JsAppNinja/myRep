(function(){
  console.log('loaded.');

  var container = document.createElement("div");
  container.id = "slot-machine";
  container.height = window.innerHeight;
  container.width = 800;

  var close = document.createElement("span");
  close.id = 'close-icon';
  close.innerHTML = '&times;';

  var iframe = document.createElement("iframe");
  iframe.height = window.innerHeight;
  iframe.width = 800;
  iframe.src = '<%= ENV["SCRIPTS_HOST"] %>/frontend';

  container.append(close);
  container.append(iframe);

  var style = document.createElement("link", {type: 'text/css'});
  style.rel = 'stylesheet';
  style.href = '<%= ENV["SCRIPTS_HOST"] %>/scripts/css';
  document.body.appendChild(style);
  document.body.appendChild(container);

  document.body.addEventListener('mouseleave', function(){
    if (!window.slotsShown && setCookie()){
      container.classList.add('show');

      var serviceParams = {
        url:       window.location.pathname,
        shop_name: window.location.hostname
      };

      iframe.contentWindow.postMessage({
          method: "createPopupActivation()",
          params: serviceParams
        }, "*"
      )
    };
    window.slotsShown = true;
  });
  close.addEventListener('click', function(){
    container.classList.remove('show');
  });


  function setCookie() {
    var version = <%= current_shop.popup_config.version %>,
        cookieKey = "<%= "slotmachine_#{current_shop.id}_version" %>",
        cookedVersion = getCookie(cookieKey);

    if (cookedVersion && version == cookedVersion) {
      return false
    }
    else {
      newCookie = cookieKey + '=' + version;
      document.cookie = newCookie;

      return true
    }
  }


  function getCookie(name) {
    var matches = document.cookie.match(new RegExp(
        "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
    ));
    return matches ? decodeURIComponent(matches[1]) : undefined;
  }

}).call(this);
