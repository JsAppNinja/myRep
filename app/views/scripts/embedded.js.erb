(function(){
  console.log('loaded.');

  var triggers       = JSON.parse('<%= raw(current_shop.popup_config.js_required_settings) %>'),
      isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

  if (isMobileDevice) {
    if (triggers.tablet_enabled == false)
      return false;
  }
  else {
    if (triggers.desktop_enabled == false)
      return false;
  }


  var container = document.createElement("div");
  container.id = "slot-machine";
  container.height = window.innerHeight;
  container.width = 800;


  var close = document.createElement("span");
  close.id = 'close-icon';
  close.innerHTML = '&times;';


  var iframe = document.createElement("iframe");
  iframe.height = window.innerHeight;
  iframe.width = 800;
  iframe.src = '<%= ENV["SCRIPTS_HOST"] %>/frontend';


  container.append(close);
  container.append(iframe);


  var style = document.createElement("link", {type: 'text/css'});
  style.rel = 'stylesheet';
  style.href = '<%= ENV["SCRIPTS_HOST"] %>/scripts/css';
  document.body.appendChild(style);
  document.body.appendChild(container);


  function showSlotMachine() {
    if (!window.slotsShown && setCookie()){
      container.classList.add('show');

      var serviceParams = {
        url:       window.location.pathname,
        shop_name: window.location.hostname
      };

      iframe.contentWindow.postMessage({
          method: "createPopupActivation()",
          params: serviceParams
        }, "*"
      )
    }
    window.slotsShown = true;
  }


  close.addEventListener('click', function(){
    container.classList.remove('show');
  });

  // listeners

  if (isMobileDevice) {
    if (<%= current_shop.popup_config.tablet_show_on_leave %>) {
      var last_scroll = 0;

      window.addEventListener('scroll', function(event){
        var offset = window.pageYOffset || document.documentElement.scrollTop;
        if (offset < last_scroll)
          showSlotMachine();
        last_scroll = offset
      });
    }

    if (<%= current_shop.popup_config.tablet_show_on_timeout %>) {
      setTimeout(function(){ showSlotMachine(); }, <%= current_shop.popup_config.tablet_show_timeout * 1000 %>)
    }
  }
  else {
    if (<%= current_shop.popup_config.desktop_show_on_leave %>) {
      document.body.addEventListener('mouseleave', function(event){
        if (event.clientY < 0)
          showSlotMachine();
      });
    }

    if (<%= current_shop.popup_config.desktop_show_on_timeout %>) {
      setTimeout(function(){ showSlotMachine(); }, <%= current_shop.popup_config.desktop_show_timeout * 1000 %>)
    }
  }


  function setCookie() {
    var version = <%= current_shop.popup_config.version %>,
        cookieKey = "<%= "slotmachine_#{current_shop.id}_version" %>",
        cookedVersion = getCookie(cookieKey);

    if (cookedVersion && version == cookedVersion) {
      return false
    }
    else {
      newCookie = cookieKey + '=' + version;
      document.cookie = newCookie;

      return true
    }
  }


  function getCookie(name) {
    var matches = document.cookie.match(new RegExp(
        "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
    ));
    return matches ? decodeURIComponent(matches[1]) : undefined;
  }

}).call(this);
